<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <title>Document</title>
</head>

<script>

    const uuidv4 = () => {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/x/g,()=>Math.floor(Math.random() * 0xf).toString(16)).replace('y',Math.floor(Math.random()*4+8).toString(16));
    }

    let peer = new Peer(uuidv4(), {
        host: "gus.ink",
        port: 8080,
        path: "/"
    });

    const socket = peer._socket._socket;

    let trusted_peer;
    let call;
    socket.addEventListener("message", (event) => {
        const ev = JSON.parse(event.data);
        console.log(`Received message ${ev}`)
        console.log(typeof ev, ev)

        switch(ev.type){
            case "call":
                console.log("Entering call case")
                if (call) {
                    call.close();
                    console.log("Closed previous call")
                }

                getUserMedia({video: true, audio: false}, function(stream) {
                    call = peer.call(ev.peer, stream)

                    console.log(ev.peer)

                    call.on('stream', function(remoteStream) {
                        const video = document.getElementById("vid");
                        video.srcObject = remoteStream;
                    });
                });
            break;

            case "assign":
                trusted_peer = ev.peer;
                console.log(`Set trusted peer to ${trusted_peer}`)
            break;
        }
    });

    const getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
    peer.on('call', function(call) {
        if(call.peer == trusted_peer){
            getUserMedia({video: true, audio: false}, function(stream) {
                call.answer(stream);

                call.on('stream', function(remoteStream) {
                    const video = document.getElementById("vid");
                    video.srcObject = remoteStream;
                });

            }, function(err) {
                console.log('Failed to get local stream' ,err);
            });
        } 
    });
</script>
<body>
    <video id="vid"></video>
</body>
</html>