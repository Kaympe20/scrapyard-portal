<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
    <title>Document</title>
</head>

<script>

    const uuidv4 = () => {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/x/g,()=>Math.floor(Math.random() * 0xf).toString(16)).replace('y',Math.floor(Math.random()*4+8).toString(16));
    }

    const local_id = uuidv4();
    console.log(`Local id is: ${local_id}`)

    let peer = new Peer(local_id, {
        host: "gus.ink",
        port: 8080,
        path: "/"
    });

    const socket = peer._socket._socket;

    let trusted_peer;
    let call;
    socket.addEventListener("message", (event) => {
        const ev = JSON.parse(event.data);

        switch(ev.type){
            case "call":
                if (call) {
                    call.close();
                }

                navigator.mediaDevices.getUserMedia({video: true, audio: false}).then( function(stream) {
                    call = peer.call(ev.peer, stream)

                    console.log(ev.peer)

                    call.on('stream', function(remoteStream) {
                        const video = document.getElementById("vid");
                        video.srcObject = remoteStream;
                    });
                });
            break;

            case "assign":
                trusted_peer = ev.peer;
                console.log(`Set trusted peer to ${trusted_peer}`)
            break;
        }
    });

    peer.on('call', function(call) {
        console.log("Receiving call", call.peer, trusted_peer, call.peer == trusted_peer)
        if(call.peer == trusted_peer){
            navigator.mediaDevices.getUserMedia({video: true, audio: false}).then( function(stream) {
                call.answer(stream);

                call.on('stream', function(remoteStream) {
                    const video = document.getElementById("vid");
                    video.srcObject = remoteStream;
                });
            })
            .catch(function(err) {
                console.log('Failed to get local stream' ,err);
            });
        } 
    });
</script>
<body>
    <video id="vid"></video>
</body>
</html>